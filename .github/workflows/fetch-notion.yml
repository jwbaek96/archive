name: Fetch Notion Data

# íŠ¸ë¦¬ê±° ì„¤ì •
on:
  # ë§¤ì¼ ì˜¤ì „ 9ì‹œ(UTC ê¸°ì¤€, í•œêµ­ì‹œê°„ ì˜¤í›„ 6ì‹œ)ì— ìë™ ì‹¤í–‰
  schedule:
    - cron: '0 9 * * *'
  
  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  workflow_dispatch:
  
  # ë©”ì¸ ë¸Œëœì¹˜ì— pushí•  ë•Œ ì‹¤í–‰
  push:
    branches: [ main ]
    paths:
      - 'scripts/**'
      - '.github/workflows/**'

jobs:
  fetch-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    # 1. ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    # 2. Node.js ì„¤ì •
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    # 3. ì˜ì¡´ì„± ì„¤ì¹˜
    - name: Install dependencies
      run: |
        npm init -y
        npm install node-fetch
    
    # 4. ë…¸ì…˜ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    - name: Fetch Notion data
      env:
        NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
        NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
      run: |
        node scripts/fetch-notion.js
    
    # 5. ë³€ê²½ì‚¬í•­ í™•ì¸ ë° ì»¤ë°‹
    - name: Check for changes
      id: verify-changed-files
      run: |
        if [ -n "$(git status --porcelain)" ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
        else
          echo "changed=false" >> $GITHUB_OUTPUT
        fi
    
    # 6. ë³€ê²½ì‚¬í•­ì´ ìˆì„ ë•Œë§Œ ì»¤ë°‹ ë° í‘¸ì‹œ
    - name: Commit and push changes
      if: steps.verify-changed-files.outputs.changed == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add data/posts.json
        git commit -m "ğŸ¤– Update blog posts from Notion [$(date '+%Y-%m-%d %H:%M:%S')]"
        git push
    
    # 7. ê²°ê³¼ ì¶œë ¥
    - name: Output result
      run: |
        if [ "${{ steps.verify-changed-files.outputs.changed }}" == "true" ]; then
          echo "âœ… ë¸”ë¡œê·¸ í¬ìŠ¤íŠ¸ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤!"
        else
          echo "â„¹ï¸ ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
        fi